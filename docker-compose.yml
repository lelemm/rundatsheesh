version: "3.9"

services:
  caddy:
    build:
      context: .
      dockerfile: services/caddy/Dockerfile
    environment:
      RDS_DOMAIN: ${RDS_DOMAIN:-localhost}
      ACME_EMAIL: ${ACME_EMAIL:-}
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
    networks:
      - rds_edge
      - rds_internal

  manager:
    build:
      context: .
      dockerfile: services/manager/Dockerfile

    # P0: least privilege hardening
    read_only: true
    security_opt:
      - no-new-privileges:true
      - seccomp=unconfined
      - apparmor=unconfined
    cap_drop:
      - ALL
    cap_add:
      - NET_ADMIN
      # Required by Firecracker jailer (mount namespace + chroot + privilege drop + dev setup).
      - SYS_ADMIN
      - SYS_CHROOT
      - SETUID
      - SETGID
      - MKNOD
      - CHOWN
      - DAC_OVERRIDE
      - DAC_READ_SEARCH
    tmpfs:
      - /tmp
      - /run

    environment:
      API_KEY: ${API_KEY:-dev-key}
      PORT: 3000
      KERNEL_PATH: /artifacts/vmlinux
      BASE_ROOTFS_PATH: /artifacts/rootfs.ext4
      STORAGE_ROOT: /var/lib/run-dat-sheesh
      AGENT_VSOCK_PORT: 8080
      ROOTFS_CLONE_MODE: ${ROOTFS_CLONE_MODE:-auto}
      ENABLE_SNAPSHOTS: ${ENABLE_SNAPSHOTS:-false}
      SNAPSHOT_TEMPLATE_CPU: ${SNAPSHOT_TEMPLATE_CPU:-1}
      SNAPSHOT_TEMPLATE_MEM_MB: ${SNAPSHOT_TEMPLATE_MEM_MB:-256}

    # Manager is reachable only via Caddy (no host port publishing)
    volumes:
      - ./services/guest-image/dist:/artifacts:ro
      # Persist all manager state to the host:
      # - per-VM rootfs clones:  /var/lib/run-dat-sheesh/<vmId>/rootfs.ext4
      # - per-VM logs:          /var/lib/run-dat-sheesh/<vmId>/logs/*
      # - snapshots:            /var/lib/run-dat-sheesh/snapshots/<snapshotId>/*
      - ${RUN_DAT_SHEESH_DATA_DIR:-./data}:/var/lib/run-dat-sheesh
    devices:
      - /dev/kvm:/dev/kvm
      - /dev/vhost-vsock:/dev/vhost-vsock
      - /dev/net/tun:/dev/net/tun
      # Optional (some hosts expose this; integration script mounts it when present)
      # - /dev/vsock:/dev/vsock
    sysctls:
      net.ipv4.ip_forward: "1"
      net.ipv4.conf.all.forwarding: "1"
      net.ipv4.conf.default.forwarding: "1"
    networks:
      - rds_internal

networks:
  rds_edge: {}
  rds_internal:
    internal: true

volumes:
  caddy_data: {}
  caddy_config: {}

