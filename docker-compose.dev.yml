version: "3.9"

# Dev-only compose: runs the manager API directly on http://127.0.0.1:3000 (no proxy/TLS).
#
# Usage:
#   cp env.example .env
#   docker compose -f docker-compose.dev.yml up --build

services:
  manager:
    build:
      context: .
      dockerfile: services/manager/Dockerfile

    # Keep dev aligned with integration + prod compose hardening.
    read_only: true
    security_opt:
      - no-new-privileges:true
      - seccomp=unconfined
      - apparmor=unconfined
    cap_drop:
      - ALL
    cap_add:
      - NET_ADMIN
      # Required by Firecracker jailer (mount namespace + chroot + privilege drop + dev setup).
      - SYS_ADMIN
      - SYS_CHROOT
      - SETUID
      - SETGID
      - MKNOD
      - CHOWN
      - DAC_OVERRIDE
      - DAC_READ_SEARCH
    tmpfs:
      - /tmp
      - /run
    sysctls:
      net.ipv4.ip_forward: "1"
      net.ipv4.conf.all.forwarding: "1"
      net.ipv4.conf.default.forwarding: "1"

    environment:
      API_KEY: ${API_KEY:-dev-key}
      PORT: 3000
      KERNEL_PATH: /artifacts/vmlinux
      BASE_ROOTFS_PATH: /artifacts/rootfs.ext4
      STORAGE_ROOT: /var/lib/run-dat-sheesh
      AGENT_VSOCK_PORT: 8080
      ROOTFS_CLONE_MODE: ${ROOTFS_CLONE_MODE:-auto}
      ENABLE_SNAPSHOTS: ${ENABLE_SNAPSHOTS:-false}
      SNAPSHOT_TEMPLATE_CPU: ${SNAPSHOT_TEMPLATE_CPU:-1}
      SNAPSHOT_TEMPLATE_MEM_MB: ${SNAPSHOT_TEMPLATE_MEM_MB:-256}
    ports:
      - "3000:3000"
    volumes:
      - ./services/guest-image/dist:/artifacts:ro
      - ${RUN_DAT_SHEESH_DATA_DIR:-./data}:/var/lib/run-dat-sheesh
    devices:
      - /dev/kvm:/dev/kvm
      - /dev/vhost-vsock:/dev/vhost-vsock
      - /dev/net/tun:/dev/net/tun
      # Optional (some hosts expose this; integration script mounts it when present)
      # - /dev/vsock:/dev/vsock

